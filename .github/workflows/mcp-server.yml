name: MCP Server CI

on:
  push:
    branches: [main]
    paths:
      - 'mcp-server/**'
  pull_request:
    branches: [main]
    paths:
      - 'mcp-server/**'
  workflow_dispatch:

concurrency:
  group: mcp-server-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Test MCP Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            mcp-server/node_modules
          key: ${{ runner.os }}-mcp-npm-${{ hashFiles('mcp-server/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-mcp-npm-
      
      - name: Install dependencies
        working-directory: mcp-server
        run: npm ci
      
      - name: Run linting
        working-directory: mcp-server
        run: npm run lint || true
        continue-on-error: true
      
      - name: Run tests
        working-directory: mcp-server
        run: npm test
      
      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./mcp-server/coverage
          flags: mcp-server
          name: mcp-server-coverage
          fail_ci_if_error: false

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: mcp-server
        run: npm ci
      
      - name: Run security audit
        working-directory: mcp-server
        run: npm audit --json > audit-report.json || true
        continue-on-error: true
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-audit
          path: mcp-server/audit-report.json
          retention-days: 7

  verify-server:
    name: Verify Server Startup
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: mcp-server
        run: npm ci
      
      - name: Start server and verify health
        working-directory: mcp-server
        run: |
          # Start server in background
          npm start &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 5
          
          # Check health endpoint
          HEALTH_STATUS=$(curl -s http://localhost:3000/health | jq -r '.status')
          
          if [ "$HEALTH_STATUS" = "healthy" ]; then
            echo "âœ… Server health check passed"
          else
            echo "âŒ Server health check failed"
            exit 1
          fi
          
          # Test endpoints exist
          curl -s http://localhost:3000/ | jq -e '.endpoints' > /dev/null
          echo "âœ… API documentation endpoint working"
          
          # Test Dependabot endpoint
          DEPENDABOT_RESULT=$(curl -s -X POST http://localhost:3000/review-dependabot \
            -H "Content-Type: application/json" \
            -d '{"prTitle": "Bump lodash from 4.17.20 to 4.17.21"}' | jq -r '.shouldApprove')
          echo "Dependabot analysis result: $DEPENDABOT_RESULT"
          
          # Test Presentation endpoint
          PRESENTATION_RESULT=$(curl -s -X POST http://localhost:3000/analyze-presentation \
            -H "Content-Type: application/json" \
            -d '{"slides": [{"type": "title", "data": {"title": "Test"}}]}' | jq -r '.score')
          echo "Presentation analysis score: $PRESENTATION_RESULT"
          
          # Test Coverage endpoint
          COVERAGE_RESULT=$(curl -s -X POST http://localhost:3000/coverage-report \
            -H "Content-Type: application/json" \
            -d '{"component": "h5p", "coverage": {"branches": 60}}' | jq -r '.passing')
          echo "Coverage report result: $COVERAGE_RESULT"
          
          # Test Suggest endpoint
          SUGGEST_RESULT=$(curl -s -X GET http://localhost:3000/suggest-code/templates | jq -r '.suggestionTypes | length')
          echo "Suggestion templates count: $SUGGEST_RESULT"
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null || true
          
          echo "âœ… All endpoint tests passed"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, security-audit, verify-server]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š MCP Server CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Server Verification: ${{ needs.verify-server.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.verify-server.result }}" = "success" ]; then
            echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some checks need attention" >> $GITHUB_STEP_SUMMARY
          fi
