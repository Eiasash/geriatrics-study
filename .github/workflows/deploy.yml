name: Deploy & Update Content

on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ← ADD THIS LINE!
      pages: write     # ← AND THIS!
      id-token: write  # ← AND THIS!
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests genanki
      
      - name: Create data directory
        run: mkdir -p data
      
      - name: Fetch latest papers (if script exists)
        run: |
          if [ -f "scripts/pubmed_fetcher.py" ]; then
            python scripts/pubmed_fetcher.py || echo "PubMed fetch failed, continuing..."
          else
            echo "PubMed fetcher not found, skipping..."
          fi
      
      - name: Create minimal content.json if missing
        run: |
          if [ ! -f "data/content.json" ]; then
            echo '[]' > data/content.json
          fi
      
      - name: Build Anki packages (if script exists)
        run: |
          mkdir -p anki/dist
          if [ -f "anki/build_apkg_enhanced.py" ]; then
            cd anki
            python build_apkg_enhanced.py || echo "Enhanced build failed, continuing..."
          else
            echo "Enhanced builder not found, skipping..."
          fi
      
      - name: Create simple index.html
        run: |
          mkdir -p dist/web
          cat > dist/web/index.html << 'EOF'
          <!DOCTYPE html>
          <html dir="rtl" lang="he">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Geriatrics Study Portal</title>
              <style>
                  body {
                      font-family: -apple-system, system-ui, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      text-align: center;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container {
                      background: white;
                      padding: 40px;
                      border-radius: 20px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                  }
                  h1 { color: #333; }
                  .status { 
                      background: #48bb78; 
                      color: white; 
                      padding: 10px 20px; 
                      border-radius: 50px; 
                      display: inline-block;
                      margin: 20px 0;
                  }
                  .links {
                      margin-top: 30px;
                  }
                  .links a {
                      display: inline-block;
                      margin: 10px;
                      padding: 12px 24px;
                      background: #667eea;
                      color: white;
                      text-decoration: none;
                      border-radius: 8px;
                  }
                  .links a:hover {
                      background: #5a67d8;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>🏥 מערכת לימוד גריאטריה</h1>
                  <h2>Shaare Tzedek Fellowship</h2>
                  <div class="status">✅ System Online</div>
                  <p>The automated study system is being built...</p>
                  <div class="links">
                      <a href="https://github.com/Eiasash/geriatrics-study">📚 Repository</a>
                      <a href="https://github.com/Eiasash/geriatrics-study/actions">⚡ Build Status</a>
                  </div>
                  <p style="margin-top: 30px; color: #666;">
                      Last updated: $(date +'%Y-%m-%d %H:%M')
                  </p>
              </div>
          </body>
          </html>
          EOF
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist/web
