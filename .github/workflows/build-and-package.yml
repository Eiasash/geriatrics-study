name: Build and Package

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  audit:
    name: Security audits (npm + pip)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Node audit (H5P)
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: h5p/package-lock.json
      - name: Install audit-ci
        run: npm i -g audit-ci
      - name: npm ci (H5P)
        working-directory: h5p
        run: npm ci
      - name: npm audit (fail on >= moderate)
        working-directory: h5p
        run: audit-ci --moderate
      
      # Python audit (Anki)
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
      - name: pip-audit (requirements.txt)
        uses: pypa/gh-action-pip-audit@v1
        with:
          inputs: anki/requirements.txt

  build:
    name: Build packages
    runs-on: ubuntu-latest
    needs: audit
    steps:
      - uses: actions/checkout@v4
      
      # Setup Node.js for H5P
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: h5p/package-lock.json
      
      # Setup Python for Anki
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
      
      # Install dependencies
      - name: Install H5P dependencies
        working-directory: h5p
        run: npm ci
      
      - name: Install Anki dependencies
        working-directory: anki
        run: pip install -r requirements.txt
      
      # Build H5P packages
      - name: Build H5P QuestionSet packages
        working-directory: h5p
        run: npm run build:qset
      
      - name: Build H5P Mega package
        working-directory: h5p
        run: |
          export TOPICS="דליריום,שבריריות (Frailty),רישום ודה-פרסקייבינג תרופות,נפילות,דמנציה ומחלת אלצהיימר"
          export PASS=75
          npm run build:mega
      
      # Build Anki package
      - name: Build Anki package
        working-directory: anki
        run: PYTHONIOENCODING=utf-8 python build_apkg.py
      
      # Upload artifacts
      - name: Upload H5P packages
        uses: actions/upload-artifact@v4
        with:
          name: h5p-packages
          path: h5p/dist/*.h5p
      
      - name: Upload Anki package
        uses: actions/upload-artifact@v4
        with:
          name: anki-package
          path: anki/dist/*.apkg