<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×”×œ ×ª×¨×•×¤×•×ª ×—×›× - AI Medication Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; }
        .gradient-header { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .drug-card { transition: all 0.3s ease; }
        .drug-card:hover { transform: translateY(-2px); }
        .risk-high { border-right: 4px solid #dc2626; }
        .risk-medium { border-right: 4px solid #f59e0b; }
        .risk-low { border-right: 4px solid #10b981; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <header class="gradient-header text-white rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                        <span class="text-4xl">ğŸ’Š</span>
                        ×× ×”×œ ×ª×¨×•×¤×•×ª ×—×›×
                    </h1>
                    <p class="text-red-100 mt-1">Beers Criteria | STOPP/START | AI Drug Interactions</p>
                </div>
                <div class="flex gap-2 no-print">
                    <button onclick="window.location.href='../index.html'" class="px-4 py-2 bg-white text-red-700 rounded-lg hover:bg-gray-100 text-sm font-medium">
                        ×“×£ ×”×‘×™×ª
                    </button>
                    <button onclick="exportReport()" class="px-4 py-2 bg-red-800 text-white rounded-lg hover:bg-red-900 text-sm font-medium">
                        ×™×™×¦× ×“×•×—
                    </button>
                </div>
            </div>
        </header>

        <!-- Patient Info -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">×¤×¨×˜×™ ××˜×•×¤×œ</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="patient-name" placeholder="×©× ×”××˜×•×¤×œ" class="px-4 py-2 border rounded-lg">
                <input type="number" id="patient-age" placeholder="×’×™×œ" class="px-4 py-2 border rounded-lg" onchange="checkAgeWarnings()">
                <input type="number" id="patient-crcl" placeholder="CrCl (mL/min)" class="px-4 py-2 border rounded-lg" onchange="checkRenalWarnings()">
                <select id="patient-frailty" class="px-4 py-2 border rounded-lg">
                    <option value="">×¨××ª ×©×‘×¨×™×¨×™×•×ª</option>
                    <option value="fit">Fit - ×—×–×§</option>
                    <option value="vulnerable">Vulnerable - ×¤×’×™×¢</option>
                    <option value="frail">Frail - ×©×‘×¨×™×¨×™</option>
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                    <label class="text-sm text-gray-600">××—×œ×•×ª ×¨×§×¢</label>
                    <input type="text" id="comorbidities" placeholder="×¡×•×›×¨×ª, ×™×œ"×“, CHF..." class="w-full px-4 py-2 border rounded-lg mt-1">
                </div>
                <div>
                    <label class="text-sm text-gray-600">××œ×¨×’×™×•×ª</label>
                    <input type="text" id="allergies" placeholder="×¤× ×™×¦×™×œ×™×Ÿ, ×¡×•×œ×¤×”..." class="w-full px-4 py-2 border rounded-lg mt-1">
                </div>
                <div>
                    <label class="text-sm text-gray-600">××©×§×œ (×§"×’)</label>
                    <input type="number" id="patient-weight" placeholder="70" class="w-full px-4 py-2 border rounded-lg mt-1">
                </div>
            </div>
        </div>

        <!-- Add Medication -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">×”×•×¡×¤×ª ×ª×¨×•×¤×”</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="text" id="drug-name" placeholder="×©× ×”×ª×¨×•×¤×”" class="px-4 py-2 border rounded-lg" list="drug-suggestions">
                <datalist id="drug-suggestions">
                    <option value="Aspirin"></option>
                    <option value="Clopidogrel"></option>
                    <option value="Warfarin"></option>
                    <option value="Apixaban"></option>
                    <option value="Rivaroxaban"></option>
                    <option value="Metoprolol"></option>
                    <option value="Amlodipine"></option>
                    <option value="Lisinopril"></option>
                    <option value="Losartan"></option>
                    <option value="Furosemide"></option>
                    <option value="Hydrochlorothiazide"></option>
                    <option value="Metformin"></option>
                    <option value="Glimepiride"></option>
                    <option value="Insulin"></option>
                    <option value="Atorvastatin"></option>
                    <option value="Omeprazole"></option>
                    <option value="Pantoprazole"></option>
                    <option value="Diazepam"></option>
                    <option value="Lorazepam"></option>
                    <option value="Zolpidem"></option>
                    <option value="Oxybutynin"></option>
                    <option value="Diphenhydramine"></option>
                    <option value="Amitriptyline"></option>
                    <option value="Quetiapine"></option>
                    <option value="Haloperidol"></option>
                    <option value="Donepezil"></option>
                    <option value="Memantine"></option>
                    <option value="Gabapentin"></option>
                    <option value="Pregabalin"></option>
                    <option value="Tramadol"></option>
                    <option value="Morphine"></option>
                </datalist>
                <input type="text" id="drug-dose" placeholder="××™× ×•×Ÿ (×œ××©×œ 5mg)" class="px-4 py-2 border rounded-lg">
                <select id="drug-frequency" class="px-4 py-2 border rounded-lg">
                    <option value="QD">×¤×¢× ×‘×™×•× (QD)</option>
                    <option value="BID">×¤×¢××™×™× ×‘×™×•× (BID)</option>
                    <option value="TID">3 ×¤×¢××™× ×‘×™×•× (TID)</option>
                    <option value="QID">4 ×¤×¢××™× ×‘×™×•× (QID)</option>
                    <option value="PRN">×œ×¤×™ ×¦×•×¨×š (PRN)</option>
                    <option value="QHS">×œ×¤× ×™ ×”×©×™× ×” (QHS)</option>
                    <option value="QWeek">×¤×¢× ×‘×©×‘×•×¢</option>
                </select>
                <input type="text" id="drug-indication" placeholder="×”×ª×•×•×™×”" class="px-4 py-2 border rounded-lg">
                <button onclick="addMedication()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    ×”×•×¡×£
                </button>
            </div>
        </div>

        <!-- Medication List -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">×¨×©×™××ª ×ª×¨×•×¤×•×ª (<span id="med-count">0</span>)</h2>
                <div class="flex gap-2 no-print">
                    <button onclick="checkAllWarnings()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-sm">
                        ğŸ” ×‘×“×•×§ ××–×”×¨×•×ª
                    </button>
                    <button onclick="askAI()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                        ğŸ¤– ×©××œ AI
                    </button>
                    <button onclick="clearAllMeds()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                        × ×§×” ×”×›×œ
                    </button>
                </div>
            </div>
            <div id="medication-list" class="space-y-3">
                <p class="text-gray-500 text-center py-8">××™×Ÿ ×ª×¨×•×¤×•×ª ×‘×¨×©×™××”. ×”×•×¡×£ ×ª×¨×•×¤×” ×œ××¢×œ×”.</p>
            </div>
        </div>

        <!-- Warnings Panel -->
        <div id="warnings-panel" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-red-700 mb-4 flex items-center gap-2">
                <span class="text-2xl">âš ï¸</span>
                ××–×”×¨×•×ª ×•×”×ª×¨××•×ª
            </h2>
            <div id="warnings-content" class="space-y-4"></div>
        </div>

        <!-- AI Analysis Panel -->
        <div id="ai-panel" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-purple-700 mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ¤–</span>
                × ×™×ª×•×— AI
            </h2>
            <div id="ai-content" class="space-y-4"></div>
        </div>

        <!-- Quick Reference: Beers Criteria -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸº</span>
                AGS Beers Criteria - ×ª×¨×•×¤×•×ª ×œ×”×™×× ×¢
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="p-4 bg-red-50 rounded-lg">
                    <h3 class="font-semibold text-red-800">CNS - ××¢×¨×›×ª ×¢×¦×‘×™×</h3>
                    <ul class="text-sm text-red-700 mt-2 space-y-1">
                        <li>â€¢ Benzodiazepines (Diazepam, Lorazepam)</li>
                        <li>â€¢ Z-drugs (Zolpidem, Zopiclone)</li>
                        <li>â€¢ Antipsychotics (×× ×™×¢×ª ×“×× ×¦×™×”)</li>
                        <li>â€¢ TCAs (Amitriptyline, Nortriptyline)</li>
                        <li>â€¢ First-gen antihistamines</li>
                    </ul>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg">
                    <h3 class="font-semibold text-orange-800">×× ×˜×™×›×•×œ×™× ×¨×’×™×•×ª</h3>
                    <ul class="text-sm text-orange-700 mt-2 space-y-1">
                        <li>â€¢ Oxybutynin, Tolterodine</li>
                        <li>â€¢ Diphenhydramine</li>
                        <li>â€¢ Promethazine</li>
                        <li>â€¢ Chlorpheniramine</li>
                        <li>â€¢ Scopolamine</li>
                    </ul>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg">
                    <h3 class="font-semibold text-yellow-800">×œ×‘ ×•×›×œ×™ ×“×</h3>
                    <ul class="text-sm text-yellow-700 mt-2 space-y-1">
                        <li>â€¢ Digoxin >0.125mg (×× ××¤×©×¨)</li>
                        <li>â€¢ Nifedipine IR</li>
                        <li>â€¢ Alpha-blockers (Doxazosin)</li>
                        <li>â€¢ Amiodarone (first-line)</li>
                        <li>â€¢ Dronedarone ×¢× CHF</li>
                    </ul>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <h3 class="font-semibold text-purple-800">×›××‘ ×•×“×œ×§×ª</h3>
                    <ul class="text-sm text-purple-700 mt-2 space-y-1">
                        <li>â€¢ NSAIDs (Ibuprofen, Diclofenac)</li>
                        <li>â€¢ Indomethacin</li>
                        <li>â€¢ Ketorolac</li>
                        <li>â€¢ Meperidine</li>
                        <li>â€¢ Muscle relaxants</li>
                    </ul>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800">GI - ××¢×¨×›×ª ×¢×™×›×•×œ</h3>
                    <ul class="text-sm text-blue-700 mt-2 space-y-1">
                        <li>â€¢ PPIs >8 weeks (×œ×œ× ×”×ª×•×•×™×”)</li>
                        <li>â€¢ Metoclopramide</li>
                        <li>â€¢ Mineral oil</li>
                    </ul>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <h3 class="font-semibold text-green-800">×× ×“×•×§×¨×™× ×™</h3>
                    <ul class="text-sm text-green-700 mt-2 space-y-1">
                        <li>â€¢ Sulfonylureas ××¨×•×›×•×ª (Glibenclamide)</li>
                        <li>â€¢ Sliding scale insulin (×‘×§×”×™×œ×”)</li>
                        <li>â€¢ Megestrol</li>
                        <li>â€¢ Growth hormone</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- AI Integration Links -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-6 text-white">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ”—</span>
                ××™× ×˜×’×¨×¦×™×•×ª AI ×œ×‘×“×™×§×ª ×ª×¨×•×¤×•×ª
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="https://www.drugs.com/drug_interactions.html" target="_blank" rel="noopener noreferrer"
                   class="p-4 bg-white/20 rounded-xl hover:bg-white/30 transition-all text-center">
                    <div class="text-2xl mb-2">ğŸ’Š</div>
                    <div class="font-medium">Drugs.com</div>
                    <div class="text-xs text-white/80">Interaction Checker</div>
                </a>
                <a href="https://www.openevidence.com" target="_blank" rel="noopener noreferrer"
                   class="p-4 bg-white/20 rounded-xl hover:bg-white/30 transition-all text-center">
                    <div class="text-2xl mb-2">ğŸ”¬</div>
                    <div class="font-medium">OpenEvidence</div>
                    <div class="text-xs text-white/80">Evidence-based</div>
                </a>
                <a href="https://www.epocrates.com/online/drugs" target="_blank" rel="noopener noreferrer"
                   class="p-4 bg-white/20 rounded-xl hover:bg-white/30 transition-all text-center">
                    <div class="text-2xl mb-2">ğŸ“±</div>
                    <div class="font-medium">Epocrates</div>
                    <div class="text-xs text-white/80">Drug Reference</div>
                </a>
                <a href="https://www.lexicomp.com" target="_blank" rel="noopener noreferrer"
                   class="p-4 bg-white/20 rounded-xl hover:bg-white/30 transition-all text-center">
                    <div class="text-2xl mb-2">ğŸ“š</div>
                    <div class="font-medium">Lexicomp</div>
                    <div class="text-xs text-white/80">Clinical Info</div>
                </a>
            </div>
        </div>

        <footer class="text-center text-gray-500 mt-8 pb-4">
            <a href="../index.html" class="hover:text-gray-700">×—×–×¨×” ×œ×“×£ ×”×‘×™×ª</a>
        </footer>
    </div>

    <script>
        let medications = JSON.parse(localStorage.getItem('geriatricMeds') || '[]');

        // Beers Criteria Database (simplified)
        const beersCriteria = {
            'diazepam': { risk: 'high', reason: 'Increased risk of falls, cognitive impairment, delirium', alternative: 'Consider non-pharmacologic sleep hygiene, if needed short-acting: Lorazepam low dose' },
            'lorazepam': { risk: 'medium', reason: 'Benzodiazepine - risk of falls, sedation', alternative: 'Use lowest dose, shortest duration' },
            'zolpidem': { risk: 'high', reason: 'Z-drug - similar risks to benzodiazepines, ER visits', alternative: 'Sleep hygiene, Melatonin, Trazodone low dose' },
            'diphenhydramine': { risk: 'high', reason: 'Highly anticholinergic - confusion, urinary retention, constipation', alternative: 'Second-gen antihistamines: Loratadine, Cetirizine' },
            'oxybutynin': { risk: 'high', reason: 'Anticholinergic - cognitive decline, delirium', alternative: 'Mirabegron, behavioral therapy' },
            'amitriptyline': { risk: 'high', reason: 'TCA - highly anticholinergic, sedating', alternative: 'SSRI, SNRI, Nortriptyline lower dose' },
            'nortriptyline': { risk: 'medium', reason: 'TCA - less anticholinergic but still risky', alternative: 'SSRI, SNRI' },
            'ibuprofen': { risk: 'high', reason: 'NSAID - GI bleeding, renal impairment, CV risk', alternative: 'Acetaminophen, Topical NSAIDs' },
            'diclofenac': { risk: 'high', reason: 'NSAID - GI bleeding, renal impairment, CV risk', alternative: 'Acetaminophen, Topical diclofenac' },
            'naproxen': { risk: 'high', reason: 'NSAID - GI bleeding, renal impairment', alternative: 'Acetaminophen' },
            'glibenclamide': { risk: 'high', reason: 'Long-acting sulfonylurea - severe hypoglycemia', alternative: 'Glimepiride, Gliclazide, Metformin' },
            'glyburide': { risk: 'high', reason: 'Long-acting sulfonylurea - severe hypoglycemia', alternative: 'Shorter-acting sulfonylureas or other classes' },
            'metoclopramide': { risk: 'high', reason: 'EPS, tardive dyskinesia risk increases with age', alternative: 'Domperidone (with caution), dietary modifications' },
            'digoxin': { risk: 'medium', reason: 'Toxicity risk if >0.125mg/day, monitor levels', alternative: 'Lower dose, rate control alternatives' },
            'nifedipine': { risk: 'high', reason: 'Immediate release - hypotension, falls', alternative: 'Extended-release CCBs: Amlodipine' },
            'doxazosin': { risk: 'high', reason: 'Alpha-blocker - orthostatic hypotension, falls', alternative: 'Tamsulosin if for BPH, other antihypertensives' },
            'quetiapine': { risk: 'high', reason: 'Antipsychotic in dementia - increased mortality', alternative: 'Non-pharmacologic approaches first' },
            'haloperidol': { risk: 'high', reason: 'Antipsychotic - EPS, falls, mortality in dementia', alternative: 'Low dose, short duration if absolutely needed' },
            'omeprazole': { risk: 'medium', reason: 'PPI >8 weeks without indication - C. diff, fractures, B12 deficiency', alternative: 'H2 blockers, step-down therapy' },
            'pantoprazole': { risk: 'medium', reason: 'PPI - same risks as omeprazole', alternative: 'Review indication, consider discontinuation' },
            'tramadol': { risk: 'medium', reason: 'Seizure risk, serotonin syndrome, falls', alternative: 'Acetaminophen, careful opioid selection' },
            'meperidine': { risk: 'high', reason: 'Neurotoxic metabolite, seizures', alternative: 'Other opioids if needed' },
            'promethazine': { risk: 'high', reason: 'Highly anticholinergic, sedating', alternative: 'Ondansetron for nausea' }
        };

        // STOPP Criteria (simplified)
        const stoppCriteria = {
            'aspirin_no_indication': 'Aspirin without clear CV indication',
            'ppi_no_indication': 'PPI without peptic ulcer, GERD, or GI bleeding risk',
            'duplicate_therapy': 'Duplicate drug classes',
            'nsaid_with_anticoag': 'NSAID with anticoagulant - high bleeding risk',
            'anticholinergic_with_dementia': 'Anticholinergic with cognitive impairment'
        };

        function addMedication() {
            const name = document.getElementById('drug-name').value.trim();
            const dose = document.getElementById('drug-dose').value.trim();
            const frequency = document.getElementById('drug-frequency').value;
            const indication = document.getElementById('drug-indication').value.trim();

            if (!name) {
                alert('× × ×œ×”×–×™×Ÿ ×©× ×ª×¨×•×¤×”');
                return;
            }

            const med = {
                id: Date.now(),
                name: name,
                dose: dose,
                frequency: frequency,
                indication: indication,
                addedAt: new Date().toISOString()
            };

            medications.push(med);
            saveMedications();
            renderMedications();
            clearInputs();
            checkSingleMedWarning(med);
        }

        function clearInputs() {
            document.getElementById('drug-name').value = '';
            document.getElementById('drug-dose').value = '';
            document.getElementById('drug-indication').value = '';
        }

        function removeMedication(id) {
            medications = medications.filter(m => m.id !== id);
            saveMedications();
            renderMedications();
        }

        function saveMedications() {
            localStorage.setItem('geriatricMeds', JSON.stringify(medications));
        }

        function renderMedications() {
            const container = document.getElementById('medication-list');
            document.getElementById('med-count').textContent = medications.length;

            if (medications.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">××™×Ÿ ×ª×¨×•×¤×•×ª ×‘×¨×©×™××”. ×”×•×¡×£ ×ª×¨×•×¤×” ×œ××¢×œ×”.</p>';
                return;
            }

            container.innerHTML = medications.map(med => {
                const beersInfo = beersCriteria[med.name.toLowerCase()];
                const riskClass = beersInfo ? (beersInfo.risk === 'high' ? 'risk-high' : 'risk-medium') : 'risk-low';

                return `
                    <div class="drug-card bg-gray-50 rounded-lg p-4 ${riskClass}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold text-gray-800 text-lg">${med.name}</div>
                                <div class="text-sm text-gray-600">${med.dose} - ${med.frequency}</div>
                                ${med.indication ? `<div class="text-sm text-gray-500">×”×ª×•×•×™×”: ${med.indication}</div>` : ''}
                                ${beersInfo ? `
                                    <div class="mt-2 p-2 ${beersInfo.risk === 'high' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'} rounded text-sm">
                                        <strong>âš ï¸ Beers:</strong> ${beersInfo.reason}
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="removeMedication(${med.id})" class="text-red-500 hover:text-red-700 text-xl no-print">Ã—</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function checkSingleMedWarning(med) {
            const beersInfo = beersCriteria[med.name.toLowerCase()];
            if (beersInfo && beersInfo.risk === 'high') {
                alert(`âš ï¸ ××–×”×¨×” - ${med.name}:\n${beersInfo.reason}\n\n×—×œ×•×¤×” ××•××œ×¦×ª: ${beersInfo.alternative}`);
            }
        }

        function checkAllWarnings() {
            const warnings = [];
            const age = parseInt(document.getElementById('patient-age').value) || 0;
            const crcl = parseInt(document.getElementById('patient-crcl').value) || 999;

            // Check Beers criteria
            medications.forEach(med => {
                const beersInfo = beersCriteria[med.name.toLowerCase()];
                if (beersInfo) {
                    warnings.push({
                        type: 'beers',
                        severity: beersInfo.risk,
                        drug: med.name,
                        message: beersInfo.reason,
                        alternative: beersInfo.alternative
                    });
                }
            });

            // Check polypharmacy
            if (medications.length >= 5) {
                warnings.push({
                    type: 'polypharmacy',
                    severity: medications.length >= 10 ? 'high' : 'medium',
                    message: `×¤×•×œ×™×¤×¨××¦×™×”: ${medications.length} ×ª×¨×•×¤×•×ª. ×©×§×•×œ deprescribing.`
                });
            }

            // Check anticholinergic burden
            const anticholinergics = ['diphenhydramine', 'oxybutynin', 'amitriptyline', 'promethazine', 'chlorpheniramine'];
            const acbCount = medications.filter(m => anticholinergics.includes(m.name.toLowerCase())).length;
            if (acbCount >= 2) {
                warnings.push({
                    type: 'acb',
                    severity: 'high',
                    message: `× ×˜×œ ×× ×˜×™×›×•×œ×™× ×¨×’×™ ×’×‘×•×”: ${acbCount} ×ª×¨×•×¤×•×ª ×× ×˜×™×›×•×œ×™× ×¨×’×™×•×ª. ×¡×™×›×•×Ÿ ×œ×“×œ×™×¨×™×•× ×•×œ×™×¨×™×“×” ×§×•×’× ×™×˜×™×‘×™×ª.`
                });
            }

            // Check drug interactions
            const drugNames = medications.map(m => m.name.toLowerCase());

            // NSAID + Anticoagulant
            const nsaids = ['ibuprofen', 'diclofenac', 'naproxen', 'aspirin'];
            const anticoags = ['warfarin', 'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban'];
            if (drugNames.some(d => nsaids.includes(d)) && drugNames.some(d => anticoags.includes(d))) {
                warnings.push({
                    type: 'interaction',
                    severity: 'high',
                    message: 'NSAID + × ×•×’×“ ×§×¨×™×©×”: ×¡×™×›×•×Ÿ ×’×‘×•×” ×××•×“ ×œ×“×™××•× GI!'
                });
            }

            // Dual antiplatelet + anticoagulant
            const antiplatelets = ['aspirin', 'clopidogrel', 'prasugrel', 'ticagrelor'];
            const hasAntiplatelet = drugNames.filter(d => antiplatelets.includes(d)).length;
            const hasAnticoag = drugNames.some(d => anticoags.includes(d));
            if (hasAntiplatelet >= 2 || (hasAntiplatelet >= 1 && hasAnticoag)) {
                warnings.push({
                    type: 'interaction',
                    severity: 'high',
                    message: '×˜×™×¤×•×œ ××©×•×œ×© ××• ×›×¤×•×œ ×× ×˜×™-×˜×¨×•××‘×•×˜×™: ×¡×™×›×•×Ÿ ×“×™××•× ×’×‘×•×”. ×”×× ×™×© ×”×ª×•×•×™×” ×‘×¨×•×¨×”?'
                });
            }

            // Renal dosing
            if (crcl < 30) {
                const renalDrugs = medications.filter(m =>
                    ['metformin', 'gabapentin', 'pregabalin', 'apixaban', 'rivaroxaban', 'dabigatran'].includes(m.name.toLowerCase())
                );
                renalDrugs.forEach(drug => {
                    warnings.push({
                        type: 'renal',
                        severity: 'high',
                        drug: drug.name,
                        message: `${drug.name} ×¢× CrCl < 30: × ×“×¨×©×ª ×”×ª×××ª ××™× ×•×Ÿ ××• ×”×¤×¡×§×”!`
                    });
                });
            }

            displayWarnings(warnings);
        }

        function displayWarnings(warnings) {
            const panel = document.getElementById('warnings-panel');
            const content = document.getElementById('warnings-content');

            if (warnings.length === 0) {
                panel.classList.add('hidden');
                alert('âœ… ×œ× × ××¦××• ××–×”×¨×•×ª ××©××¢×•×ª×™×•×ª');
                return;
            }

            panel.classList.remove('hidden');

            content.innerHTML = warnings.map(w => {
                const bgColor = w.severity === 'high' ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200';
                const textColor = w.severity === 'high' ? 'text-red-700' : 'text-yellow-700';

                return `
                    <div class="p-4 ${bgColor} border rounded-lg">
                        <div class="font-semibold ${textColor}">
                            ${w.severity === 'high' ? 'ğŸ”´' : 'ğŸŸ¡'} ${w.drug || w.type.toUpperCase()}
                        </div>
                        <div class="text-sm mt-1 ${textColor}">${w.message}</div>
                        ${w.alternative ? `<div class="text-sm mt-2 text-green-700">ğŸ’¡ ×—×œ×•×¤×”: ${w.alternative}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function askAI() {
            if (medications.length === 0) {
                alert('× × ×œ×”×•×¡×™×£ ×ª×¨×•×¤×•×ª ×œ×¨×©×™××” ×§×•×“×');
                return;
            }

            const age = document.getElementById('patient-age').value || '×œ× ×¦×•×™×Ÿ';
            const crcl = document.getElementById('patient-crcl').value || '×œ× ×¦×•×™×Ÿ';
            const comorbidities = document.getElementById('comorbidities').value || '×œ× ×¦×•×™×Ÿ';

            const medList = medications.map(m => `${m.name} ${m.dose} ${m.frequency}`).join(', ');

            const query = encodeURIComponent(
                `[Geriatric Medication Review]\n` +
                `Patient: Age ${age}, CrCl ${crcl}\n` +
                `Comorbidities: ${comorbidities}\n` +
                `Medications: ${medList}\n\n` +
                `Please review this medication list for:\n` +
                `1. Beers Criteria concerns\n` +
                `2. Drug-drug interactions\n` +
                `3. Renal dosing adjustments needed\n` +
                `4. Anticholinergic burden\n` +
                `5. Deprescribing opportunities\n` +
                `6. Missing medications (START criteria)`
            );

            // Show AI panel
            const aiPanel = document.getElementById('ai-panel');
            const aiContent = document.getElementById('ai-content');
            aiPanel.classList.remove('hidden');

            aiContent.innerHTML = `
                <div class="p-4 bg-purple-50 rounded-lg">
                    <p class="text-purple-700">ğŸ¤– ×¤×•×ª×— ×× ×•×¢×™ AI ×œ× ×™×ª×•×— ×¨×©×™××ª ×”×ª×¨×•×¤×•×ª...</p>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <a href="https://www.openevidence.com" target="_blank" rel="noopener noreferrer"
                           class="p-3 bg-blue-100 hover:bg-blue-200 rounded-lg text-center text-blue-700">
                            ğŸ”¬ OpenEvidence
                        </a>
                        <a href="https://chat.openai.com" target="_blank" rel="noopener noreferrer"
                           class="p-3 bg-green-100 hover:bg-green-200 rounded-lg text-center text-green-700">
                            ğŸ’š ChatGPT
                        </a>
                        <a href="https://claude.ai" target="_blank" rel="noopener noreferrer"
                           class="p-3 bg-orange-100 hover:bg-orange-200 rounded-lg text-center text-orange-700">
                            ğŸ§¡ Claude
                        </a>
                        <a href="https://www.perplexity.ai/search?q=${query}" target="_blank" rel="noopener noreferrer"
                           class="p-3 bg-purple-100 hover:bg-purple-200 rounded-lg text-center text-purple-700">
                            ğŸ”® Perplexity
                        </a>
                    </div>
                </div>
            `;

            // Copy query to clipboard and open OpenEvidence
            navigator.clipboard.writeText(`[Geriatric Medication Review] ${medList}`).catch(() => {});
            window.open('https://www.openevidence.com', '_blank', 'noopener,noreferrer');
        }

        function clearAllMeds() {
            if (confirm('×”×× ×œ××—×•×§ ××ª ×›×œ ×”×ª×¨×•×¤×•×ª?')) {
                medications = [];
                saveMedications();
                renderMedications();
                document.getElementById('warnings-panel').classList.add('hidden');
                document.getElementById('ai-panel').classList.add('hidden');
            }
        }

        function exportReport() {
            const name = document.getElementById('patient-name').value || '×œ× ×¦×•×™×Ÿ';
            const age = document.getElementById('patient-age').value || '×œ× ×¦×•×™×Ÿ';
            const crcl = document.getElementById('patient-crcl').value || '×œ× ×¦×•×™×Ÿ';

            let report = `×“×•×— ×ª×¨×•×¤×•×ª - ${new Date().toLocaleDateString('he-IL')}\n`;
            report += `==========================================\n\n`;
            report += `××˜×•×¤×œ: ${name}\n`;
            report += `×’×™×œ: ${age}\n`;
            report += `CrCl: ${crcl}\n\n`;
            report += `×¨×©×™××ª ×ª×¨×•×¤×•×ª (${medications.length}):\n`;
            report += `------------------------------------------\n`;

            medications.forEach((med, i) => {
                report += `${i + 1}. ${med.name} ${med.dose} ${med.frequency}\n`;
                if (med.indication) report += `   ×”×ª×•×•×™×”: ${med.indication}\n`;
                const beers = beersCriteria[med.name.toLowerCase()];
                if (beers) {
                    report += `   âš ï¸ Beers: ${beers.reason}\n`;
                    report += `   ğŸ’¡ ×—×œ×•×¤×”: ${beers.alternative}\n`;
                }
            });

            // Copy to clipboard
            navigator.clipboard.writeText(report).then(() => {
                alert('×”×“×•×— ×”×•×¢×ª×§ ×œ×œ×•×—!');
            });
        }

        function checkAgeWarnings() {
            const age = parseInt(document.getElementById('patient-age').value);
            if (age >= 85) {
                alert('âš ï¸ ××˜×•×¤×œ ××‘×•×’×¨ ×××•×“ (85+)\n×©×§×•×œ:\nâ€¢ ×”×¤×—×ª×ª ××™× ×•× ×™×\nâ€¢ ×”×¤×¡×§×ª ×ª×¨×•×¤×•×ª ××™×•×ª×¨×•×ª\nâ€¢ ×™×¢×“×™× ××ª×•× ×™× ×™×•×ª×¨ ×œ×¡×•×›×¨×ª ×•×œ×—×¥ ×“×');
            }
        }

        function checkRenalWarnings() {
            const crcl = parseInt(document.getElementById('patient-crcl').value);
            if (crcl < 30) {
                alert('âš ï¸ ××™-×¡×¤×™×§×ª ×›×œ×™×•×ª ××©××¢×•×ª×™×ª (CrCl < 30)\n× ×“×¨×©×•×ª ×”×ª×××•×ª ××™× ×•×Ÿ ×œ×ª×¨×•×¤×•×ª ×¨×‘×•×ª!');
            } else if (crcl < 60) {
                alert('âš ï¸ ×™×¨×™×“×” ×‘×ª×¤×§×•×“ ×›×œ×™×™×ª×™ (CrCl < 60)\n×©×§×•×œ ×”×ª×××ª ××™× ×•×Ÿ ×œ×ª×¨×•×¤×•×ª × ×‘×—×¨×•×ª');
            }
        }

        // Initialize
        renderMedications();
    </script>
</body>
</html>
