<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - Geriatrics Fellowship</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background-color: #f9fafb;
            line-height: 1.5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        header h1 { font-size: 1.875rem; font-weight: 700; color: #111827; }
        header p { color: #4b5563; font-size: 0.875rem; }
        
        /* Button styles */
        button { 
            padding: 0.5rem 1rem; 
            border: none; 
            border-radius: 0.5rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s;
            font-size: 0.875rem;
            min-height: 44px; /* Touch target size */
        }
        button:active { transform: scale(0.98); }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        .btn-green { background: #10b981; color: white; }
        .btn-green:hover { background: #059669; }
        .btn-gray { background: #6b7280; color: white; }
        .btn-gray:hover { background: #4b5563; }
        .btn-red { background: #ef4444; color: white; }
        .btn-red:hover { background: #dc2626; }
        
        .flex { display: flex; }
        .gap-3 { gap: 0.75rem; }
        .flex-wrap { flex-wrap: wrap; }
        
        /* Grid */
        .grid { display: grid; gap: 1rem; margin-bottom: 1.5rem; }
        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        
        /* Cards */
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem; }
        .card-stat { text-align: center; }
        .card-stat-number { font-size: 1.5rem; font-weight: 700; }
        .card-stat-label { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
        .text-blue { color: #3b82f6; }
        .text-red { color: #ef4444; }
        .text-yellow { color: #f59e0b; }
        .text-green { color: #10b981; }
        
        /* Patient card */
        .patient-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }
        .patient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .alert-high { border-left: 4px solid #dc3545; }
        .alert-med { border-left: 4px solid #ffc107; }
        .alert-low { border-left: 4px solid #28a745; }
        
        /* Section */
        .section-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .section-header h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem; }
        .section-header p { color: #6b7280; font-size: 0.875rem; }
        .section-content { padding: 1.5rem; }
        
        /* Empty state */
        .empty-state { text-align: center; padding: 3rem 1rem; color: #6b7280; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); overflow-y: auto; z-index: 50; }
        .modal.hidden { display: none; }
        .modal-content { 
            position: relative; 
            margin: 5rem auto; 
            padding: 1.25rem; 
            border: 1px solid #e5e7eb; 
            max-width: 90%; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            border-radius: 0.5rem; 
            background: white; 
        }
        .modal-header { margin-bottom: 1rem; }
        .modal-header h3 { font-size: 1.125rem; font-weight: 600; color: #111827; }
        
        /* Form */
        .form-grid { display: grid; gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .form-input, .form-select, .form-textarea { 
            display: block; 
            width: 100%; 
            padding: 0.5rem 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            font-size: 0.875rem;
            min-height: 44px; /* Touch target */
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        }
        .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap; }
        
        /* Responsive */
        @media (min-width: 768px) {
            .container { padding: 2rem; }
            header h1 { font-size: 2rem; }
            .grid-cols-1 { grid-template-columns: repeat(2, 1fr); }
            .md-grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
            .form-grid { grid-template-columns: repeat(2, 1fr); }
            .modal-content { max-width: 75%; }
        }
        
        @media (min-width: 1024px) {
            .modal-content { max-width: 50%; }
        }
        
        @media (max-width: 767px) {
            header { flex-direction: column; align-items: flex-start; }
            .flex.gap-3 { width: 100%; }
            .flex.gap-3 button { flex: 1; min-width: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>Patient Dashboard</h1>
                <p>Morning Rounds - Shaare Zedek Geriatrics</p>
            </div>
            <div class="flex gap-3">
                <button onclick="addNewPatient()" class="btn-blue">
                    ‚ûï Add Patient
                </button>
                <button onclick="exportReport()" class="btn-green">
                    üì§ Export Report
                </button>
                <button onclick="window.location.href='../index.html'" class="btn-gray">
                    üè† Home
                </button>
            </div>
        </header>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md-grid-cols-4">
            <div class="card card-stat">
                <div class="card-stat-number text-blue" id="totalPatients">0</div>
                <div class="card-stat-label">Total Patients</div>
            </div>
            <div class="card card-stat">
                <div class="card-stat-number text-red" id="highRisk">0</div>
                <div class="card-stat-label">High Risk</div>
            </div>
            <div class="card card-stat">
                <div class="card-stat-number text-yellow" id="pendingTasks">0</div>
                <div class="card-stat-label">Pending Tasks</div>
            </div>
            <div class="card card-stat">
                <div class="card-stat-number text-green" id="completedToday">0</div>
                <div class="card-stat-label">Completed Today</div>
            </div>
        </div>

        <!-- Patient List -->
        <div class="card">
            <div class="section-header">
                <h2>Active Patients</h2>
                <p>Click on a patient to view/edit details</p>
            </div>
            <div id="patientList" class="section-content">
                <!-- Patients will be loaded here -->
            </div>
        </div>

        <!-- Add Patient Modal -->
        <div id="addPatientModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Add New Patient</h3>
                </div>
                <form id="addPatientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Room Number</label>
                            <input type="text" id="room" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Initials</label>
                            <input type="text" id="initials" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="number" id="age" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sex</label>
                            <select id="sex" class="form-select">
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Main Problems (comma separated)</label>
                        <textarea id="problems" rows="3" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Medications (comma separated)</label>
                        <textarea id="medications" rows="3" class="form-textarea"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddPatientModal()" class="btn-gray">
                            Cancel
                        </button>
                        <button type="submit" class="btn-blue">
                            Add Patient
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        console.log('Patient Dashboard Script Loading...');

        // Patient data management
        let patients = [];

        // Safe localStorage operations
        function loadPatients() {
            try {
                const stored = localStorage.getItem('geriatricPatients');
                patients = stored ? JSON.parse(stored) : [];
                console.log('Loaded patients:', patients.length);
            } catch (error) {
                console.error('Error loading patients:', error);
                patients = [];
            }
        }

        function savePatients() {
            try {
                localStorage.setItem('geriatricPatients', JSON.stringify(patients));
                console.log('Saved patients:', patients.length);
            } catch (error) {
                console.error('Error saving patients:', error);
                alert('Error saving patient data. Please try again.');
            }
        }

        // Initialize the dashboard
        function init() {
            console.log('Initializing dashboard...');
            try {
                loadPatients();
                renderPatients();
                updateStats();

                // Add form handler with error handling
                const form = document.getElementById('addPatientForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        addPatient();
                    });
                    console.log('Form handler added successfully');
                } else {
                    console.error('Form not found!');
                }
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error initializing dashboard. Please refresh the page.');
            }
        }

        function renderPatients() {
            console.log('Rendering patients...');
            const patientList = document.getElementById('patientList');

            if (patients.length === 0) {
                patientList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üè•</div>
                        <p>No patients added yet</p>
                        <button onclick="addNewPatient()" class="btn-blue" style="margin-top: 1rem;">
                            Add Your First Patient
                        </button>
                    </div>
                `;
                return;
            }

            patientList.innerHTML = patients.map(patient => `
                <div class="patient-card card ${getRiskClass(patient)}" onclick="editPatient('${patient.id}')" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1; min-width: 200px;">
                            <h3 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.25rem;">Room ${patient.room} - ${patient.initials}</h3>
                            <p style="color: #6b7280; font-size: 0.875rem;">${patient.age}yo ${patient.sex === 'M' ? 'Male' : 'Female'}</p>
                            <div style="margin-top: 0.5rem;">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #374151;">Problems:</span>
                                <p style="font-size: 0.875rem; color: #6b7280;">${patient.problems?.join(', ') || 'None listed'}</p>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #374151;">Medications:</span>
                                <p style="font-size: 0.875rem; color: #6b7280;">${patient.meds?.slice(0,3).join(', ') || 'None listed'}${patient.meds?.length > 3 ? '...' : ''}</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <span style="padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; ${getRiskBadgeStyle(patient)}">
                                ${getRiskLevel(patient)}
                            </span>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                Added: ${new Date(patient.dateAdded).toLocaleDateString('he-IL')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getRiskClass(patient) {
            const riskScore = calculateRiskScore(patient);
            if (riskScore >= 7) return 'alert-high';
            if (riskScore >= 4) return 'alert-med';
            return 'alert-low';
        }

        function getRiskBadgeStyle(patient) {
            const riskScore = calculateRiskScore(patient);
            if (riskScore >= 7) return 'background: #fee2e2; color: #991b1b;';
            if (riskScore >= 4) return 'background: #fef3c7; color: #92400e;';
            return 'background: #d1fae5; color: #065f46;';
        }

        function getRiskLevel(patient) {
            const riskScore = calculateRiskScore(patient);
            if (riskScore >= 7) return 'High Risk';
            if (riskScore >= 4) return 'Medium Risk';
            return 'Low Risk';
        }

        function calculateRiskScore(patient) {
            let score = 0;
            if (patient.age >= 85) score += 2;
            else if (patient.age >= 75) score += 1;

            if (patient.meds && patient.meds.length >= 10) score += 3;
            else if (patient.meds && patient.meds.length >= 5) score += 2;

            if (patient.problems && patient.problems.length >= 5) score += 2;
            else if (patient.problems && patient.problems.length >= 3) score += 1;

            return score;
        }

        function updateStats() {
            console.log('Updating stats...');
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('highRisk').textContent = patients.filter(p => calculateRiskScore(p) >= 7).length;
            document.getElementById('pendingTasks').textContent = patients.filter(p => !p.completed).length;
            document.getElementById('completedToday').textContent = patients.filter(p => {
                const today = new Date().toDateString();
                return p.lastUpdated && new Date(p.lastUpdated).toDateString() === today;
            }).length;
        }

        function addNewPatient() {
            console.log('Add new patient clicked');
            document.getElementById('addPatientModal').classList.remove('hidden');
        }

        function closeAddPatientModal() {
            console.log('Close modal clicked');
            document.getElementById('addPatientModal').classList.add('hidden');
            document.getElementById('addPatientForm').reset();
        }

        function addPatient() {
            console.log('Add patient form submitted');
            try {
                const room = document.getElementById('room');
                const initials = document.getElementById('initials');
                const age = document.getElementById('age');
                const sex = document.getElementById('sex');
                const problems = document.getElementById('problems');
                const medications = document.getElementById('medications');

                if (!room || !initials || !age || !sex) {
                    alert('Please fill in all required fields');
                    return;
                }

                if (!room.value.trim() || !initials.value.trim() || !age.value) {
                    alert('Please fill in all required fields');
                    return;
                }

                const newPatient = {
                    id: Date.now().toString(),
                    room: room.value.trim(),
                    initials: initials.value.trim(),
                    age: parseInt(age.value) || 0,
                    sex: sex.value,
                    problems: problems.value ? problems.value.split(',').map(p => p.trim()).filter(p => p) : [],
                    meds: medications.value ? medications.value.split(',').map(m => m.trim()).filter(m => m) : [],
                    dateAdded: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    completed: false
                };

                patients.push(newPatient);
                savePatients();

                closeAddPatientModal();
                renderPatients();
                updateStats();

                alert(`Patient ${newPatient.initials} added successfully!`);
            } catch (error) {
                console.error('Error adding patient:', error);
                alert('Error adding patient. Please try again.');
            }
        }

        function editPatient(patientId) {
            console.log('Edit patient clicked:', patientId);
            try {
                const patient = patients.find(p => p.id === patientId);
                if (!patient) {
                    alert('Patient not found');
                    return;
                }

                const action = confirm(`Edit patient ${patient.initials} in Room ${patient.room}?\n\nClick OK to edit, Cancel to mark as completed.`);

                if (action) {
                    const newRoom = prompt('Room number:', patient.room);
                    if (newRoom && newRoom.trim()) {
                        patient.room = newRoom.trim();
                        patient.lastUpdated = new Date().toISOString();
                        savePatients();
                        renderPatients();
                        updateStats();
                        alert('Patient updated successfully');
                    }
                } else {
                    patient.completed = true;
                    patient.lastUpdated = new Date().toISOString();
                    savePatients();
                    renderPatients();
                    updateStats();
                    alert('Patient marked as completed');
                }
            } catch (error) {
                console.error('Error editing patient:', error);
                alert('Error updating patient. Please try again.');
            }
        }

        function exportReport() {
            console.log('Export report clicked');
            try {
                if (patients.length === 0) {
                    alert('No patients to export. Add patients first.');
                    return;
                }

                const date = new Date().toLocaleDateString('en-US');
                let report = `MORNING REPORT - Shaare Zedek Geriatrics\n${date}\n\n`;

                patients.forEach(p => {
                    report += `Room ${p.room}: ${p.initials} (${p.age}yo ${p.sex})\n`;
                    report += `Problems: ${p.problems && p.problems.length > 0 ? p.problems.join(', ') : 'None listed'}\n`;
                    report += `Medications: ${p.meds && p.meds.length > 0 ? p.meds.slice(0,5).join(', ') : 'None listed'}${p.meds && p.meds.length > 5 ? '...' : ''}\n`;
                    report += `Risk Level: ${getRiskLevel(p)}\n`;
                    report += `Status: ${p.completed ? 'Completed' : 'Pending'}\n`;
                    report += '---\n';
                });

                report += `\nSummary:\nTotal: ${patients.length} patients\nHigh Risk: ${patients.filter(p => calculateRiskScore(p) >= 7).length}\nPending: ${patients.filter(p => !p.completed).length}`;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(report).then(() => {
                        alert('Morning report copied to clipboard! Paste in WhatsApp/Email.');
                    }).catch(() => {
                        const textArea = document.createElement('textarea');
                        textArea.value = report;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('Morning report copied to clipboard! Paste in WhatsApp/Email.');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = report;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Morning report copied to clipboard! Paste in WhatsApp/Email.');
                }
            } catch (error) {
                console.error('Error exporting report:', error);
                alert('Error exporting report. Please try again.');
            }
        }

        // Initialize when page loads
        console.log('Setting up load event listener...');
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing...');
            init();
        });

        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for load event');
        } else {
            console.log('Document already loaded, initializing now');
            init();
        }

        console.log('Script loaded completely');
    </script>
</body>
</html>
